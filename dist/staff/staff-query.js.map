{"version":3,"sources":["../../src/staff/staff-query.js"],"names":["require","config","jwt","bcrypt","makeStaffQuery","database","Object","freeze","add","getStaff","findById","findByEmail","auth","update","deleteById","max","before","after","db","query","_id","$lt","makeId","$gt","collection","find","limit","Number","toArray","map","documentToStaff","staffId","staff","password","hashSync","found","findOne","email","status","message","result","ops","insertOne","catch","mongoError","errorCode","split","_","mongoIndex","UniqueConstraintError","console","log","passwordValid","compare","token","sign","process","env","JWT_SECRET","expiresIn","user","department","lastname","othernames","id","newSet","$set","gender","phone","bday","bmonth","position","date","updateOne","upsert","deleteMany","success","n","doc"],"mappings":"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","sourcesContent":["require('dotenv').config();\nimport makeStaff from './staff'\nimport { UniqueConstraintError } from '../helpers/errors'\n\nconst jwt = require('jsonwebtoken');\nconst bcrypt = require('bcryptjs');\n\nexport default function makeStaffQuery({database}){\n    return Object.freeze({\n        add,\n        getStaff,\n        findById,\n        findByEmail,\n        auth,\n        update,\n        deleteById\n    });\n\n    async function getStaff ({ max = 100, before, after } = {}) {\n      const db = await database;\n      const query = {}\n      if (before || after) {\n      query._id = {}\n      query._id = before ? { ...query._id, $lt: db.makeId(before) } : query._id\n      query._id = after ? { ...query._id, $gt: db.makeId(after) } : query._id\n      }\n\n      return (await db\n      .collection('Staff')\n      .find(query)\n      .limit(Number(max))\n      .toArray()).map(documentToStaff)\n    }\n\n    async function add ({ staffId, ...staff}) {\n        const db = await database\n        if (staffId) {\n          staff._id = db.makeId(staffId)\n        }\n        staff.password = bcrypt.hashSync(staff.password, 10);\n\n        const found = await db\n          .collection('Staff')\n          .findOne({ email: staff.email })\n\n        if (found) {\n          return {\n            status: \"Error\",\n            message: \"Email already exist\"\n          };\n        }\n\n        const { result, ops } = await db\n          .collection('Staff')\n          .insertOne(staff)\n          .catch(mongoError => {\n            const [errorCode] = mongoError.message.split(' ')\n            if (errorCode === 'E11000') {\n              const [_, mongoIndex] = mongoError.message.split(':')[2].split(' ')\n              throw new UniqueConstraintError(\n                mongoIndex === 'ContactEmailIndex' ? 'emailAddress' : 'contactId'\n              )\n            }\n            throw mongoError\n          })\n        return {\n          status: \"Success\",\n          message: \"Staff created\"\n        }\n    }\n\n    async function auth ({ email, password }) {\n      console.log(\"Auth post query called\")\n        const db = await database\n        const found = await db\n          .collection('Staff')\n          .findOne({ email: email })\n\n        if (found) {\n            const passwordValid = await bcrypt.compare(password, found.password);\n           \n            if (passwordValid){\n               \n                const token = jwt.sign({ password: password }, process.env.JWT_SECRET, {\n                    expiresIn: '1d'\n                });\n                console.log(token)\n                return {\n                    token: token,\n                    status: \"Login Successful\",\n                    user: {\n                      \"email\": found.email,\n                      \"department\": found.department,\n                      \"lastname\": found.lastname,\n                      \"othernames\": found.othernames\n                    }\n                };\n            }\n            else {\n                return {\n                    token: \"Nil\",\n                    status: \"Password not match\"\n                };\n            }\n            \n        }\n        else {\n            return {\n                token: \"Nil\",\n                status :\"Email not found\"\n            }\n            \n        }\n       \n    }\n\n    async function update ({ id, ...staff }) {\n      \n        const db = await database\n        const query = {\n          _id: db.makeId(id)\n        }\n        \n\n        const newSet = {\n          $set : {\n\n            lastname: staff.lastname, \n            othernames: staff.othernames, \n            email: staff.email, \n            gender: staff.gender, \n            phone: staff.phone, \n            bday: staff.bday, \n            bmonth: staff.bmonth, \n            department: staff.department, \n            position: staff.position, \n            password: bcrypt.hashSync(staff.password, 10),\n            date: staff.date\n\n          } \n        }\n        /*if (id) {\n          _id = db.makeId(id)\n        }*/\n        const { result } = await db\n          .collection('Staff')\n          .updateOne(query, newSet, {upsert:true})\n          \n\n          if (result) {\n            return {\n              status: \"success\",\n              message: \"Reset successfully\"\n            }\n          }\n          else {\n            return {\n              status: \"error\",\n              message: \"Error updating\"\n            }\n          }\n        \n    }\n\n    async function findById ({ id }) {\n      const db = await database\n      const found = await db\n        .collection('Staff')\n        .findOne({ _id: db.makeId(id) })\n      if (found) {\n        return documentToStaff(found)\n      }\n      return null\n    }\n\n    async function findByEmail ({ email }) {\n      const db = await database\n      const found = await db\n        .collection('Staff')\n        .findOne({ email: email })\n      if (found) {\n        return documentToStaff(found)\n      }\n      return null\n    }\n\n\n   \n  async function deleteById ({ id }) {\n    const db = await database\n\n    const { result } = await db.collection('Staff').deleteMany({\"_id\": db.makeId(id)})\n    return {\n      success: result.n\n    }\n    \n  }\n\n  function documentToStaff ({ _id: id, ...doc }) {\n    return makeStaff({ id, ...doc })\n  }\n}"],"file":"staff-query.js"}