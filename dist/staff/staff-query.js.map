{"version":3,"sources":["../../src/staff/staff-query.js"],"names":["require","config","jwt","bcrypt","makeStaffQuery","database","Object","freeze","add","getStaff","findById","findByEmail","auth","reset","deleteById","max","before","after","console","log","db","query","_id","$lt","makeId","$gt","collection","find","limit","Number","toArray","map","documentToStaff","staffId","staff","password","hashSync","found","findOne","email","status","message","result","ops","insertOne","catch","mongoError","errorCode","split","_","mongoIndex","UniqueConstraintError","passwordValid","compare","token","sign","process","env","JWT_SECRET","expiresIn","user","department","name","id","newSet","$set","lastname","othernames","gender","phone","bday","bmonth","position","date","updateOne","upsert","deleteMany","success","n","doc"],"mappings":"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","sourcesContent":["require('dotenv').config();\nimport makeStaff from './staff'\nimport { UniqueConstraintError } from '../helpers/errors'\n\nconst jwt = require('jsonwebtoken');\nconst bcrypt = require('bcryptjs');\n\nexport default function makeStaffQuery({database}){\n    return Object.freeze({\n        add,\n        getStaff,\n        findById,\n        findByEmail,\n        auth,\n        reset,\n        deleteById\n    });\n\n    async function getStaff ({ max = 100, before, after } = {}) {\n    \n      console.log(\"Staff get found\")\n      const db = await database;\n      const query = {}\n      if (before || after) {\n      query._id = {}\n      query._id = before ? { ...query._id, $lt: db.makeId(before) } : query._id\n      query._id = after ? { ...query._id, $gt: db.makeId(after) } : query._id\n      }\n\n      return (await db\n      .collection('Staff')\n      .find(query)\n      .limit(Number(max))\n      .toArray()).map(documentToStaff)\n    }\n\n    async function add ({ staffId, ...staff}) {\n        const db = await database\n        if (staffId) {\n          staff._id = db.makeId(staffId)\n        }\n        staff.password = bcrypt.hashSync(staff.password, 10);\n\n        const found = await db\n          .collection('Staff')\n          .findOne({ email: staff.email })\n\n        if (found) {\n          return {\n            status: \"Error\",\n            message: \"Email already exist\"\n          };\n        }\n\n        const { result, ops } = await db\n          .collection('Staff')\n          .insertOne(staff)\n          .catch(mongoError => {\n            const [errorCode] = mongoError.message.split(' ')\n            if (errorCode === 'E11000') {\n              const [_, mongoIndex] = mongoError.message.split(':')[2].split(' ')\n              throw new UniqueConstraintError(\n                mongoIndex === 'ContactEmailIndex' ? 'emailAddress' : 'contactId'\n              )\n            }\n            throw mongoError\n          })\n        return {\n          status: \"Success\",\n          message: \"Staff created\"\n        }\n    }\n\n    async function auth ({ email, password }) {\n       console.log(\"staff query entered\")\n        const db = await database\n        const found = await db\n          .collection('Staff')\n          .findOne({ email: email })\n          console.log(\"staff query queried\")\n\n        if (found) {\n          console.log(\"staff query password found\")\n            const passwordValid = await bcrypt.compare(password, found.password);\n           \n            if (passwordValid){\n               \n                const token = jwt.sign({ password: password }, process.env.JWT_SECRET, {\n                    expiresIn: '1d'\n                });\n                return {\n                    token: token,\n                    status: \"Login Successful\",\n                    user: {\n                      \"email\": found.email,\n                      \"department\": found.department,\n                      \"name\": found.name\n                    }\n                };\n            }\n            else {\n                return {\n                    token: \"Nil\",\n                    status: \"Password not match\"\n                };\n            }\n            \n        }\n        else {\n            return {\n                token: \"Nil\",\n                status :\"Email not found\"\n            }\n            \n        }\n       \n    }\n\n    async function reset ({ id, ...staff }) {\n      \n        const db = await database\n        const query = {\n          _id: db.makeId(id)\n        }\n        \n\n        const newSet = {\n          $set : {\n\n            lastname: staff.lastname, \n            othernames: staff.othernames, \n            email: staff.email, \n            gender: staff.gender, \n            phone: staff.phone, \n            bday: staff.bday, \n            bmonth: staff.bmonth, \n            department: staff.department, \n            position: staff.position, \n            password: bcrypt.hashSync(staff.password, 10),\n            date: staff.date\n\n          } \n        }\n        /*if (id) {\n          _id = db.makeId(id)\n        }*/\n        const { result } = await db\n          .collection('Staff')\n          .updateOne(query, newSet, {upsert:true})\n          \n\n          if (result) {\n            return {\n              status: \"success\",\n              message: \"Reset successfully\"\n            }\n          }\n          else {\n            return {\n              status: \"error\",\n              message: \"Error updating\"\n            }\n          }\n        \n    }\n\n    async function findById ({ id }) {\n      const db = await database\n      const found = await db\n        .collection('Staff')\n        .findOne({ _id: db.makeId(id) })\n      if (found) {\n        return documentToStaff(found)\n      }\n      return null\n    }\n\n    async function findByEmail ({ email }) {\n      const db = await database\n      const found = await db\n        .collection('Staff')\n        .findOne({ email: email })\n      if (found) {\n        return documentToStaff(found)\n      }\n      return null\n    }\n\n\n   \n  async function deleteById ({ id }) {\n    const db = await database\n\n    const { result } = await db.collection('Staff').deleteMany({\"_id\": db.makeId(id)})\n    return {\n      success: result.n\n    }\n    \n  }\n\n  function documentToStaff ({ _id: id, ...doc }) {\n    return makeStaff({ id, ...doc })\n  }\n}"],"file":"staff-query.js"}